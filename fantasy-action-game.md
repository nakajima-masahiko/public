# fantasy-action-game.html 解説

## 1. 使用ライブラリ
このゲームは**外部ライブラリを使っていません**。`<script>` 内のプレーンな JavaScript だけで実装されています。

- 描画: HTML5 Canvas (`getContext("2d")`)
- 入力: `keydown` / `keyup` とモバイル用 `touchstart` / `touchend`
- ループ: `requestAnimationFrame`
- 画面構成: HTML + CSS（UI・オーバーレイ・モバイル操作ボタン）

つまり構成としては「**Vanilla JS + Canvas 2D API**」の単一ファイルゲームです。

---

## 2. プログラム構造
全体は即時実行関数 `(function(){ ... })();` で包まれ、グローバル汚染を避けた構造になっています。処理の流れは次の通りです。

### 初期化
- キャンバス・コンテキスト取得
- ゲーム状態変数（`state`, `score`, `stg`, `camX` など）初期化
- 入力イベント登録（キーボード、モバイル）

### 主要データ生成関数
- `mkPl()` : プレイヤー初期ステータス生成
- `mkLv(stage)` : ステージ生成（地面・足場・敵・コイン・ボス）
- `mkEn(x, type, stage)` : 雑魚敵生成（slime / bat）
- `mkBs(stage)` : ボス生成（ステージ別に能力が変化）

### ユーティリティ
- `grav(entity)` : 重力・着地判定
- `col(a, b)` : AABB衝突判定
- `addP(...)` : パーティクル演出生成
- `swBox()` : プレイヤーの攻撃判定矩形を返す

### 毎フレーム更新 (`update`)
- プレイヤー移動・ジャンプ・攻撃・無敵時間更新
- カメラ追従
- 敵AI更新と被ダメージ処理
- ボスAI更新（突進/飛行弾/魔法弾）
- コイン取得、パーティクル寿命管理
- HP・スコア・ステージUI反映
- 死亡/クリア時の状態遷移（`gameover`, `stageclear`, `allclear`）

### 描画 (`draw`)
- 背景（空グラデ、星、山、樹木）
- プラットフォーム、コイン、敵、ボス、プレイヤー
- 弾・パーティクル・前景レイヤ
- 画面シェイク適用

### UI制御
- `showOv()` : タイトル/ゲームオーバー/ステージクリア表示切替
- START/NEXT/RETRY ボタンでゲーム再開・次ステージ遷移

### メインループ
- `loop()` で `update()` → `draw()` → `requestAnimationFrame(loop)` を繰り返し
- `resize()` で表示領域に応じてCanvasの見た目サイズを調整

---

## 3. キャラクター構成
### プレイヤー（騎士）
- 体力: `hp/mhp = 100`
- 行動: 左右移動、ジャンプ、近接攻撃（剣）
- 戦闘補助: 攻撃クールダウン、攻撃判定時間、被弾後無敵（`inv`）
- 向き: `fR`（右向きフラグ）で攻撃方向・描画を切替

### 通常敵
1. **Slime**
   - 地上移動型
   - ステージに応じて速度・HP増加
   - 単純往復AI（端で反転）

2. **Bat**
   - 空中飛行型
   - `sin` 波で上下しながら横移動
   - ステージに応じて速度・HP増加

### ボス（各ステージ1体）
1. **DARK TREANT**（Stage 1）
   - パターン: `charge`
   - 地上追尾＋周期ジャンプ

2. **SHADOW DRAKE**（Stage 2）
   - パターン: `fly`
   - 空中を上下移動し、プレイヤー狙い弾を発射

3. **DEMON LORD**（Stage 3）
   - パターン: `magic`
   - 地上追尾しつつ3way魔法弾を連射

### 共通システム
- 敵・ボスともに `hp/mhp` を持つ
- プレイヤー攻撃ヒット時はパーティクルとスコア加算
- 接触・弾ヒットでプレイヤーがダメージ
- ボス撃破後、演出タイマー（`clrT`）を経てステージクリア遷移
