<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Advanced Charts - FX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
        }

        #tradingview_chart {
            width: 100vw;
            height: 100vh;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #333;
            text-align: center;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #f44336;
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 16px;
            max-width: 80%;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="tradingview_chart"></div>
    <div class="loading" id="loading">チャートを読み込み中</div>
    <div class="error" id="error"></div>

    <!-- TradingView Charting Library -->
    <script type="text/javascript" src="/charting_library/charting_library.min.js"></script>
    <!-- UDF Datafeed -->
    <script type="text/javascript" src="/datafeeds/udf/dist/bundle.js"></script>

    <script type="text/javascript">
        // デバッグモード（URLパラメータ ?debug=true で有効化）
        const urlParams = new URLSearchParams(window.location.search);
        const DEBUG = urlParams.get('debug') === 'true';
        const log = DEBUG ? console.log.bind(console) : () => {};

        // UDFサーバーURL（環境に応じて自動切り替え）
        const UDF_SERVER_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8080/tradingview-udf'
            : '/tradingview-udf';

        // ローカルストレージのキー
        const STORAGE_KEY = 'tradingview_chart_settings';

        // デフォルト設定
        const DEFAULT_SETTINGS = {
            symbol: 'USDJPY',
            interval: '1D',
            theme: 'light'
        };

        // ローカルストレージから設定を読み込む
        function loadSettings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    return { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
                }
            } catch (e) {
                log('Failed to load settings:', e);
            }
            return DEFAULT_SETTINGS;
        }

        // ローカルストレージに設定を保存する
        function saveSettings(settings) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
                log('Settings saved:', settings);
            } catch (e) {
                log('Failed to save settings:', e);
            }
        }

        // エラー表示
        function showError(message) {
            const errorEl = document.getElementById('error');
            const loadingEl = document.getElementById('loading');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            loadingEl.style.display = 'none';
        }

        // 初期設定を読み込み
        const settings = loadSettings();
        log('Loaded settings:', settings);

        // TradingView Widget の初期化
        function initTradingView() {
            try {
                const widget = new TradingView.widget({
                    // データフィード設定
                    datafeed: new Datafeeds.UDFCompatibleDatafeed(
                        UDF_SERVER_URL,
                        10000  // update frequency in milliseconds
                    ),

                    // 基本設定
                    symbol: settings.symbol,
                    interval: settings.interval,
                    container: 'tradingview_chart',
                    library_path: '/charting_library/',

                    // ローカライゼーション
                    locale: 'ja',
                    timezone: 'Asia/Tokyo',

                    // UI設定
                    theme: settings.theme || 'light',
                    style: '1',  // キャンドルスティック
                    toolbar_bg: '#f1f3f6',

                    // 機能の有効化
                    enabled_features: [
                        'study_templates',
                        'side_toolbar_in_fullscreen_mode',
                        'header_in_fullscreen_mode'
                    ],

                    // 機能の無効化
                    // FROM/TO関連のUIを無効化（データ取得APIが直近1000件のみ対応のため）
                    disabled_features: [
                        'go_to_date',              // 日付指定ジャンプを無効化
                        'timeframes_toolbar'       // 時間枠ツールバーを無効化
                    ],

                    // チャート設定
                    autosize: true,
                    fullscreen: false,
                    studies_overrides: {},

                    // オーバーライド
                    overrides: {
                        'mainSeriesProperties.style': 1,
                        'mainSeriesProperties.showCountdown': true,
                    },

                    // ウィジェットの準備完了時のコールバック
                    loading_screen: {
                        backgroundColor: '#ffffff',
                        foregroundColor: '#2962FF'
                    },

                    // チャートが準備できたら呼ばれる
                    onReady: function() {
                        log('TradingView Widget is ready');
                        document.getElementById('loading').style.display = 'none';
                    }
                });

                // シンボル変更時に設定を保存
                widget.onChartReady(function() {
                    log('Chart is ready');

                    // シンボル変更イベント
                    widget.activeChart().onSymbolChanged().subscribe(null, function(symbolData) {
                        log('Symbol changed:', symbolData);
                        settings.symbol = symbolData.name;
                        saveSettings(settings);
                    });

                    // インターバル変更イベント
                    widget.activeChart().onIntervalChanged().subscribe(null, function(interval) {
                        log('Interval changed:', interval);
                        settings.interval = interval;
                        saveSettings(settings);
                    });

                    // テーマ変更イベント
                    widget.onThemeChanged().subscribe(null, function(theme) {
                        log('Theme changed:', theme);
                        settings.theme = theme;
                        saveSettings(settings);
                    });
                });

            } catch (e) {
                log('Failed to initialize TradingView Widget:', e);
                showError('チャートの初期化に失敗しました: ' + e.message);
            }
        }

        // TradingView ライブラリが読み込まれたら初期化
        function checkAndInit() {
            if (typeof TradingView === 'undefined') {
                showError('TradingView ライブラリの読み込みに失敗しました。charting_library/charting_library.min.js を配置してください。');
                return;
            }
            if (typeof Datafeeds === 'undefined') {
                showError('Datafeeds ライブラリの読み込みに失敗しました。datafeeds/udf/dist/bundle.js を配置してください。');
                return;
            }
            initTradingView();
        }

        if (typeof TradingView !== 'undefined' && typeof Datafeeds !== 'undefined') {
            checkAndInit();
        } else {
            window.addEventListener('load', checkAndInit);
        }
    </script>
</body>
</html>
